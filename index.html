<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SwiftQueue Clinic Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
    .status-badge { padding: 2px 10px; border-radius: 999px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
  </style>

  <script type="module">
    import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
    import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, where, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // YOUR CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyCDxci4g-9QFvo_6ymov1mxdvn7Jf_mhvg",
      authDomain: "clinicqueue-d9d3a.firebaseapp.com",
      projectId: "clinicqueue-d9d3a",
      storageBucket: "clinicqueue-d9d3a.firebasestorage.app",
      messagingSenderId: "45318170672",
      appId: "1:45318170672:web:3edd81acbb292c2889a5f5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const qRef = collection(db, "queue");

    function ClinicApp() {
      const [view, setView] = useState('reg'); // reg, doc, tv
      const [queue, setQueue] = useState([]);
      const [manualNum, setManualNum] = useState('');
      const [audioEnabled, setAudioEnabled] = useState(false);

      // Listen to Database
      useEffect(() => {
        const q = query(qRef, orderBy("num", "asc"));
        return onSnapshot(q, (snapshot) => {
          setQueue(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });
      }, []);

      // Voice Logic
      useEffect(() => {
        if (!audioEnabled) return;
        const calling = queue.find(p => p.status === 'calling');
        if (calling) {
          const msg = new SpeechSynthesisUtterance(`Number ${calling.num}, please proceed to ${calling.loc}`);
          window.speechSynthesis.cancel();
          window.speechSynthesis.speak(msg);
        }
      }, [queue, audioEnabled]);

      const register = async () => {
        if(!manualNum) return;
        await addDoc(qRef, { num: parseInt(manualNum), status: 'waiting', loc: '', time: Date.now() });
        setManualNum('');
      };

      const callPatient = async (id, room) => {
        await updateDoc(doc(db, "queue", id), { status: 'calling', loc: room, time: Date.now() });
        setTimeout(() => updateDoc(doc(db, "queue", id), { status: 'consulting' }), 10000);
      };

      const sendToPharmacy = async (id) => {
        await updateDoc(doc(db, "queue", id), { status: 'pharmacy', loc: 'Dispensary' });
      };

      const complete = async (id) => await deleteDoc(doc(db, "queue", id));

      return React.createElement('div', { className: 'min-h-screen bg-slate-50' },
        // Simple Nav
        React.createElement('nav', { className: 'bg-slate-900 text-white p-4 flex justify-center gap-4' },
          ['reg', 'doc', 'tv'].map(v => React.createElement('button', { key: v, onClick: () => setView(v), className: 'capitalize' }, v))
        ),

        // Views
        view === 'reg' && React.createElement('div', { className: 'p-8 max-w-xl mx-auto' },
          React.createElement('h2', { className: 'text-2xl font-bold mb-4' }, 'Registration'),
          React.createElement('div', { className: 'flex gap-2 mb-8' },
            React.createElement('input', { value: manualNum, onChange: e => setManualNum(e.target.value), type: 'number', placeholder: '1001', className: 'border p-2 rounded w-full' }),
            React.createElement('button', { onClick: register, className: 'bg-blue-600 text-white px-4 rounded' }, 'Add')
          ),
          // Live Table
          React.createElement('div', { className: 'bg-white shadow rounded' },
            queue.map(p => React.createElement('div', { key: p.id, className: 'p-4 border-b flex justify-between' }, 
              React.createElement('span', { className: 'font-bold' }, `#${p.num}`),
              React.createElement('span', { className: 'status-badge bg-blue-100' }, p.status)
            ))
          )
        ),

        view === 'doc' && React.createElement('div', { className: 'p-8 max-w-2xl mx-auto' },
          React.createElement('h2', { className: 'text-2xl font-bold mb-4' }, 'Doctor Panel'),
          queue.map(p => React.createElement('div', { key: p.id, className: 'bg-white p-4 mb-2 shadow rounded flex justify-between items-center' },
            React.createElement('span', { className: 'text-xl font-bold' }, `#${p.num}`),
            React.createElement('div', { className: 'flex gap-2' },
              p.status === 'waiting' && React.createElement('button', { onClick: () => callPatient(p.id, 'Room 1'), className: 'bg-indigo-600 text-white px-3 py-1 rounded text-sm' }, 'Call'),
              p.status === 'consulting' && React.createElement('button', { onClick: () => sendToPharmacy(p.id), className: 'bg-green-600 text-white px-3 py-1 rounded text-sm' }, 'Done')
            )
          ))
        ),

        view === 'tv' && React.createElement('div', { className: 'h-[90vh] bg-slate-900 text-white flex flex-col items-center justify-center' },
          React.createElement('h1', { className: 'text-blue-400 text-4xl mb-8' }, 'NOW CALLING'),
          React.createElement('div', { className: 'text-[15rem] font-black' }, queue.find(p => p.status === 'calling')?.num || '----'),
          React.createElement('div', { className: 'text-5xl text-green-400' }, queue.find(p => p.status === 'calling')?.loc || 'Please Wait'),
          React.createElement('button', { onClick: () => setAudioEnabled(true), className: 'mt-20 opacity-20' }, 'Enable Audio')
        )
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(ClinicApp));
  </script>
</head>
<body>
  <div id="root"></div>
</body>
</html>
