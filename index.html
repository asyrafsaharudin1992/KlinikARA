<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>SwiftQueue TV</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

<!-- React -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

<style>
body {
  margin: 0;
  font-family: Inter, sans-serif;
  background: #0f172a;
  color: white;
  overflow: hidden;
}

.big-num {
  font-size: 16vw;
  font-weight: 900;
}

.animate {
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0%,100% { color:#60a5fa }
  50% { color:white }
}

.ticker {
  background: black;
  color: #fbbf24;
  height: 45px;
  overflow: hidden;
  display: flex;
  align-items: center;
  font-weight: 900;
}

.ticker span {
  white-space: nowrap;
  animation: scroll 40s linear infinite;
  padding-left: 100%;
}

@keyframes scroll {
  from { transform: translateX(0); }
  to { transform: translateX(-100%); }
}
</style>
</head>

<body>
<div id="root"></div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyCDxci4g-9QFvo_6ymov1mxdvn7Jf_mhvg",
  authDomain: "clinicqueue-d9d3a.firebaseapp.com",
  projectId: "clinicqueue-d9d3a"
});

firebase.auth().signInAnonymously();
const db = firebase.firestore();

/* ================= AUDIO (TIZEN SAFE) ================= */
const playSequence = async (files) => {
  for (const src of files) {
    await new Promise(resolve => {
      const a = new Audio(src);
      a.volume = 1.0;
      a.onended = resolve;
      a.onerror = resolve;
      a.play();
    });
  }
};

const speakAirportStyle = async (num, loc, status) => {
  const n = String(num).padStart(3,"0");

  const files = [
    "audio/chime.mp3",
    "audio/attention.mp3",
    `audio/number_${n}.mp3`,
    status === "collecting"
      ? "audio/proceed_to_medication.mp3"
      : `audio/proceed_to_${loc.replace(" ","_").toLowerCase()}.mp3`
  ];

  playSequence(files);
};

/* ================= APP ================= */
function App() {
  const [queue, setQueue] = React.useState([]);
  const [view, setView] = React.useState("tv");
  const lastCall = React.useRef(null);

  React.useEffect(() => {
    return db.collection("queue").doc("B1")
      .collection("patients")
      .orderBy("time", "desc")
      .onSnapshot(snap => {
        setQueue(snap.docs.map(d => ({ id: d.id, ...d.data() })));
      });
  }, []);

  const active = React.useMemo(() => {
    return queue
      .filter(p => ["calling","collecting"].includes(p.status))
      .sort((a,b)=>(b.callTrigger||0)-(a.callTrigger||0))[0];
  }, [queue]);

  React.useEffect(() => {
    if (!active) return;
    const cid = active.id + active.callTrigger;
    if (cid !== lastCall.current) {
      lastCall.current = cid;
      speakAirportStyle(active.num, active.loc, active.status);
    }
  }, [active]);

  return (
    React.createElement("div",{className:"h-screen flex flex-col"},
      
      React.createElement("div",{className:"ticker"},
        React.createElement("span",null,
          "SELAMAT DATANG KE KLINIK ARA 24 JAM • SILA TUNGGU NOMBOR ANDA DIPANGGIL • "
        )
      ),

      React.createElement("div",{className:"flex-1 flex items-center justify-center flex-col"},
        React.createElement("div",{className:"text-4xl uppercase opacity-40 mb-4"},"Now Calling"),
        React.createElement("div",{className:`big-num ${active?"animate":""}`},
          active?.num || "----"
        ),
        React.createElement("div",{className:"text-4xl mt-4 font-black text-emerald-400"},
          active?.loc || "STANDBY"
        )
      )
    )
  );
}

ReactDOM.createRoot(document.getElementById("root"))
  .render(React.createElement(App));
</script>
</body>
</html>
