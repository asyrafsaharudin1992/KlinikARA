<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SwiftQueue Pro - Console Master</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; margin: 0; overflow: hidden; height: 100vh; }
    .tv-mode { background-color: #0f172a; color: white; }
    .app-container { display: flex; flex-direction: column; height: 100vh; width: 100vw; }
    .nav-bar { background: white; border-bottom: 2px solid #e2e8f0; height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 25px; z-index: 1000; }
    .ticker-bar { background: #000; color: #fbbf24; height: 50px; display: flex; align-items: center; overflow: hidden; font-size: 1.4rem; font-weight: 800; border-bottom: 4px solid #1e293b; }
    .ticker-move { white-space: nowrap; animation: marquee 40s linear infinite; display: inline-block; padding-left: 100%; }
    @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
    
    /* Layout Structure */
    .view-content { flex: 1; display: grid; grid-template-columns: 1fr 400px; overflow: hidden; gap: 20px; padding: 20px; box-sizing: border-box; }
    .console-card { background: white; border-radius: 24px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; height: 100%; border: 1px solid #e2e8f0; }
    .sidebar-monitor { background: white; border-radius: 24px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; overflow: hidden; height: 100%; }

    /* TV Styling */
    .tv-grid { display: grid; grid-template-columns: 1.6fr 1.1fr; flex: 1; gap: 2vw; padding: 2vw; overflow: hidden; }
    .big-num { font-size: 18vw; font-weight: 900; line-height: 1; }
    @keyframes pulse-call { 0%, 100% { color: #60a5fa; transform: scale(1); } 50% { color: #ffffff; transform: scale(1.03); } }
    .animate-flash { animation: pulse-call 1.5s ease-in-out infinite; }
    
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCDxci4g-9QFvo_6ymov1mxdvn7Jf_mhvg",
      authDomain: "clinicqueue-d9d3a.firebaseapp.com",
      projectId: "clinicqueue-d9d3a",
      storageBucket: "clinicqueue-d9d3a.firebasestorage.app",
      messagingSenderId: "45318170672",
      appId: "1:45318170672:web:3edd81acbb292c2889a5f5",
      measurementId: "G-S5NEHZD6F3"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const speakAirportStyle = (num, loc, status) => {
        const chime = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
        chime.volume = 0.8;
        chime.play().then(() => {
            chime.onended = () => {
                const msg = new SpeechSynthesisUtterance();
                if (status === 'collecting' || loc.toLowerCase().includes('pharmacy') || loc.toLowerCase().includes('counter')) {
                    msg.text = `Attention number ${num}. Kindly proceed to medication counter. I repeat. Number ${num}. Medication counter.`;
                } else {
                    msg.text = `Attention please. Number ${num}. Please proceed to ${loc}. I repeat. Number ${num}. Please proceed to ${loc}.`;
                }
                msg.lang = 'en-US'; msg.rate = 0.82; msg.pitch = 1.0;
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(msg);
            };
        }).catch(e => console.log("TV Interaction Required"));
    };

    function App() {
      const [view, setView] = React.useState('reg');
      const [branchKey, setBranchKey] = React.useState(localStorage.getItem('branch') || 'B1');
      const [branchNames] = React.useState({ B1: 'Kajang', B2: 'Seri Kembangan', B3: 'Semenyih' });
      const [queue, setQueue] = React.useState([]);
      const [audioOn, setAudioOn] = React.useState(false);
      const [now, setNow] = React.useState(new Date());
      const lastCallId = React.useRef(null);

      React.useEffect(() => {
        localStorage.setItem('branch', branchKey);
        const unsub = db.collection("queue").doc(branchKey).collection("patients")
          .orderBy("time", "desc").onSnapshot(s => setQueue(s.docs.map(d => ({id: d.id, ...d.data()}))));
        const t = setInterval(() => setNow(new Date()), 1000);
        return () => { unsub(); clearInterval(t); };
      }, [branchKey]);

      const activePatient = React.useMemo(() => {
        return queue.filter(p => p.status === 'calling' || p.status === 'collecting')
                    .sort((a,b) => (b.callTrigger || 0) - (a.callTrigger || 0))[0];
      }, [queue]);

      React.useEffect(() => {
        if (view === 'tv' && audioOn && activePatient) {
          const callId = `${activePatient.id}-${activePatient.callTrigger}`;
          if (callId !== lastCallId.current) {
            lastCallId.current = callId;
            speakAirportStyle(activePatient.num, activePatient.loc, activePatient.status);
          }
        }
      }, [activePatient, audioOn, view]);

      const updateStatus = (id, s, l, p, trigger = false) => {
        const data = { status: s, loc: l, lastUpdated: Date.now() };
        if (trigger) data.callTrigger = Date.now();
        db.collection("queue").doc(branchKey).collection("patients").doc(id).update(data);
      };

      const SidebarMonitor = ({ isTV = false }) => (
        React.createElement('div', { className: isTV ? 'flex-1 bg-white/5 border border-white/10 rounded-[40px] overflow-hidden flex flex-col' : 'sidebar-monitor' },
          React.createElement('div', { className: `p-4 font-black text-center text-[11px] uppercase tracking-widest ${isTV ? 'bg-white/10 text-white' : 'bg-slate-900 text-white'}` }, 'Queue Monitor'),
          React.createElement('div', { className: 'overflow-y-auto flex-1 p-4 custom-scrollbar' },
            queue.map(p => React.createElement('div', { key: p.id, className: `flex justify-between items-center py-4 border-b ${isTV ? 'border-white/10' : 'border-slate-50'}` },
              React.createElement('div', { className: 'flex flex-col' },
                React.createElement('span', { className: isTV ? 'text-5xl font-black text-white' : 'font-black text-2xl text-slate-800' }, `#${p.num}`),
                React.createElement('span', { className: isTV ? 'text-lg text-blue-400 font-bold truncate w-48' : 'text-xs font-bold text-blue-600 truncate w-40' }, p.name),
                React.createElement('span', { className: 'text-[9px] uppercase font-bold text-slate-400' }, p.loc)
              ),
              React.createElement('span', { className: isTV ? 'text-xl font-black text-emerald-500 uppercase' : 'text-[10px] font-black uppercase px-3 py-1 bg-blue-50 text-blue-700 rounded-full border border-blue-100' }, p.status)
            ))
          )
        )
      );

      return React.createElement('div', { className: `app-container ${view === 'tv' ? 'tv-mode' : ''}` },
        
        React.createElement('header', { className: `nav-bar ${view === 'tv' ? 'hidden' : ''}` },
          React.createElement('div', { className: 'flex items-center gap-6' },
            React.createElement('h1', { className: 'font-black text-blue-900 text-2xl tracking-tighter' }, 'KLINIK ARA 24 JAM'),
            React.createElement('select', { value: branchKey, onChange: (e) => setBranchKey(e.target.value), className: 'bg-slate-100 p-2 rounded-xl font-bold text-sm outline-none' }, 
              Object.keys(branchNames).map(k => React.createElement('option', {key:k, value:k}, branchNames[k].toUpperCase()))
            )
          ),
          React.createElement('div', { className: 'flex gap-2' },
            ['reg', 'doc', 'pharmacy', 'tv'].map(v => React.createElement('button', { key: v, onClick: () => setView(v), className: `nav-btn ${view === v ? 'nav-btn-active' : 'nav-btn-inactive'}` }, v.toUpperCase()))
          )
        ),

        React.createElement('div', { className: 'ticker-bar' },
            React.createElement('div', { className: 'ticker-move' }, `SELAMAT DATANG KE KLINIK ARA 24 JAM | SEMOGA SEMUA DIKURNIAKAN KESABARAN DAN KESEMBUHAN DARIPIDA SEGALA BENTUK PENYAKIT â€¢ `)
        ),

        view === 'tv' ? 
          React.createElement('div', { className: 'flex-1 flex flex-col overflow-hidden' },
            React.createElement('div', { className: 'tv-grid' },
              React.createElement('div', { className: 'bg-white/5 border-2 border-white/10 rounded-[60px] flex flex-col items-center justify-center relative' },
                !audioOn && React.createElement('div', { onClick: () => { setAudioOn(true); window.speechSynthesis.speak(new SpeechSynthesisUtterance("System Active")); }, className: 'absolute inset-0 bg-black z-50 rounded-[60px] flex flex-col items-center justify-center cursor-pointer text-center px-10' }, 
                    React.createElement('h1', {className:'text-5xl font-black text-blue-400 mb-6'}, 'SYSTEM READY'),
                    React.createElement('button', {className:'px-16 py-8 bg-blue-600 rounded-full text-white text-3xl font-black shadow-2xl'}, 'START SYSTEM')
                ),
                React.createElement('span', { className: 'text-blue-400 text-5xl font-black opacity-30 mb-2' }, 'NOW CALLING'),
                React.createElement('h1', { className: `big-num ${activePatient ? 'animate-flash' : ''}` }, activePatient?.num || '----'),
                React.createElement('span', { className: 'text-5xl font-black text-white/80 mb-8 uppercase' }, activePatient?.name || ''),
                React.createElement('span', { className: 'text-emerald-400 text-[6vw] font-black uppercase' }, activePatient?.loc || 'Standby')
              ),
              React.createElement('div', { className: 'flex flex-col gap-6' },
                React.createElement('div', { className: 'bg-white/10 p-10 rounded-[40px] text-center shadow-xl border border-white/10' },
                  React.createElement('div', { className: 'text-[7.5rem] font-black text-blue-300 leading-none' }, now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12: true})),
                  React.createElement('div', { className: 'text-4xl font-black mt-2 uppercase' }, now.toLocaleDateString('en-GB', {weekday:'long', day:'2-digit', month:'long'}))
                ),
                React.createElement(SidebarMonitor, { isTV: true })
              )
            )
          ) 
          : 
          React.createElement('div', { className: 'view-content' },
            React.createElement('div', { className: 'console-card' },
              view === 'reg' && React.createElement('div', { className: 'p-12' },
                React.createElement('h2', { className: 'text-2xl font-black mb-6 text-slate-300 uppercase tracking-widest' }, 'Patient Registration'),
                React.createElement('input', { id: 'pname', placeholder: 'Enter Patient Name', className: 'w-full text-xl font-bold p-4 border-2 rounded-2xl mb-4' }),
                React.createElement('input', { id: 'qnum', type: 'number', placeholder: 'Queue No', className: 'w-full text-center text-8xl font-black p-6 border-4 rounded-[40px] mb-8 outline-none' }),
                React.createElement('button', { onClick: () => { 
                    const n = document.getElementById('qnum').value; const nm = document.getElementById('pname').value;
                    if(n) db.collection("queue").doc(branchKey).collection("patients").add({num:n, name:nm || 'Patient', status:'waiting', loc:'Waiting Area', time:Date.now()}); 
                    document.getElementById('qnum').value = ''; document.getElementById('pname').value = '';
                }, className: 'w-full bg-blue-600 text-white text-3xl font-black py-8 rounded-[40px] shadow-lg active:scale-95 transition-all' }, 'REGISTER PATIENT')
              ),
              view === 'doc' && React.createElement('div', { className: 'flex flex-col h-full' },
                React.createElement('div', { className: 'p-4 bg-slate-900 text-white flex font-bold text-[11px] uppercase tracking-widest' },
                   React.createElement('span', { className: 'w-16' }, 'NUM'),
                   React.createElement('span', { className: 'flex-1' }, 'PATIENT NAME'),
                   React.createElement('span', { className: 'w-32' }, 'LOCATION'),
                   React.createElement('span', { className: 'w-48 text-right' }, 'CONTROLS')
                ),
                React.createElement('div', { className: 'flex-1 overflow-y-auto custom-scrollbar' },
                  queue.filter(p => p.status !== 'finished').map(p => React.createElement('div', { key: p.id, className: 'p-4 border-b flex items-center hover:bg-slate-50 transition-colors' },
                      React.createElement('span', {className:'w-16 text-3xl font-black text-blue-800'}, `#${p.num}`),
                      React.createElement('span', {className:'flex-1 font-bold uppercase text-slate-700 truncate pr-4'}, p.name),
                      React.createElement('span', {className:'w-32 text-[10px] font-black text-slate-400 uppercase'}, p.loc),
                      React.createElement('div', {className:'w-48 flex gap-1 justify-end'},
                          React.createElement('button', { onClick: () => updateStatus(p.id, 'calling', 'Room 1', p, true), className: 'bg-slate-800 text-white px-3 py-2 rounded-xl text-[10px] font-black' }, 'R1'),
                          React.createElement('button', { onClick: () => updateStatus(p.id, 'calling', 'Room 2', p, true), className: 'bg-slate-800 text-white px-3 py-2 rounded-xl text-[10px] font-black' }, 'R2'),
                          React.createElement('button', { onClick: () => updateStatus(p.id, 'in room', p.loc, p), className: 'bg-blue-500 text-white px-3 py-2 rounded-xl text-[10px] font-black' }, 'IN'),
                          React.createElement('button', { onClick: () => updateStatus(p.id, 'to dispensary', 'Medication Counter', p), className: 'bg-emerald-600 text-white px-3 py-2 rounded-xl text-[10px] font-black' }, 'DISP')
                      )
                  ))
                )
              ),
              view === 'pharmacy' && React.createElement('div', { className: 'flex flex-col h-full' },
                React.createElement('div', { className: 'p-4 bg-emerald-900 text-white flex font-bold text-[11px] uppercase tracking-widest' },
                   React.createElement('span', { className: 'w-16' }, 'NUM'),
                   React.createElement('span', { className: 'flex-1' }, 'PATIENT NAME'),
                   React.createElement('span', { className: 'w-32' }, 'LOCATION'),
                   React.createElement('span', { className: 'w-48 text-right' }, 'CONTROLS')
                ),
                React.createElement('div', { className: 'flex-1 overflow-y-auto custom-scrollbar' },
                  queue.filter(p => ['to dispensary', 'collecting'].includes(p.status)).map(p => React.createElement('div', { key: p.id, className: 'p-6 border-b flex items-center hover:bg-emerald-50 transition-colors' },
                      React.createElement('span', {className:'w-16 text-4xl font-black text-emerald-900'}, `#${p.num}`),
                      React.createElement('span', {className:'flex-1 text-lg font-black uppercase text-emerald-700 truncate pr-4'}, p.name),
                      React.createElement('span', {className:'w-32 text-xs font-bold text-slate-400'}, p.loc),
                      React.createElement('div', {className:'w-48 flex gap-2 justify-end'},
                          React.createElement('button', { onClick: () => updateStatus(p.id, 'collecting', 'Medication Counter', p, true), className: 'bg-emerald-600 text-white px-6 py-3 rounded-2xl font-black text-xs shadow-md' }, 'CALL'),
                          React.createElement('button', { onClick: () => updateStatus(p.id, 'finished', 'Done', p), className: 'bg-slate-800 text-white px-6 py-3 rounded-2xl font-black text-xs' }, 'DONE')
                      )
                  ))
                )
              )
            ),
            React.createElement(SidebarMonitor, { isTV: false })
          )
      );
    }
    ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
  </script>
</body>
</html>
