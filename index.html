<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SwiftQueue Clinic Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0/client"
      }
    }
  </script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div id="root"></div>

  <script type="module">
    import React, { useState, useEffect } from 'react';
    import ReactDOM from 'react-dom';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, where, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // 1. Initialize Firebase with your project details
    const firebaseConfig = {
      apiKey: "AIzaSyCDxci4g-9QFvo_6ymov1mxdvn7Jf_mhvg",
      authDomain: "clinicqueue-d9d3a.firebaseapp.com",
      projectId: "clinicqueue-d9d3a",
      storageBucket: "clinicqueue-d9d3a.firebasestorage.app",
      messagingSenderId: "45318170672",
      appId: "1:45318170672:web:3edd81acbb292c2889a5f5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const qRef = collection(db, "queue");

    function ClinicApp() {
      const [view, setView] = useState('reg'); 
      const [queue, setQueue] = useState([]);
      const [manualNum, setManualNum] = useState('');
      const [audioEnabled, setAudioEnabled] = useState(false);

      // Listen for data updates across all computers
      useEffect(() => {
        const q = query(qRef, orderBy("time", "desc"));
        return onSnapshot(q, (snapshot) => {
          setQueue(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });
      }, []);

      // Audio Calling Logic for the TV
      useEffect(() => {
        if (view === 'tv' && audioEnabled) {
          const currentlyCalling = queue.find(p => p.status === 'calling');
          if (currentlyCalling) {
            const msg = new SpeechSynthesisUtterance(`${currentlyCalling.num}... please proceed to ${currentlyCalling.loc}`);
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(msg);
          }
        }
      }, [queue, view, audioEnabled]);

      // Actions
      const register = async () => {
        if(!manualNum) return;
        await addDoc(qRef, { num: parseInt(manualNum), status: 'waiting', loc: '', time: Date.now() });
        setManualNum('');
      };

      const callToDoc = async (id, room) => {
        await updateDoc(doc(db, "queue", id), { status: 'calling', loc: room, time: Date.now() });
        // Auto-change status to 'consulting' after 15 seconds so TV clears
        setTimeout(() => updateDoc(doc(db, "queue", id), { status: 'consulting' }), 15000);
      };

      const sendToPharmacy = async (id) => {
        await updateDoc(doc(db, "queue", id), { status: 'pharmacy', loc: 'Dispensary', time: Date.now() });
      };

      const callToPharmacy = async (id) => {
        await updateDoc(doc(db, "queue", id), { status: 'calling', loc: 'Dispensary', time: Date.now() });
      };

      const finishPatient = async (id) => await deleteDoc(doc(db, "queue", id));

      // UI Rendering
      return React.createElement('div', { className: 'min-h-screen flex flex-col' },
        // Simple Navigation for staff
        React.createElement('nav', { className: 'bg-slate-900 p-4 flex gap-4 text-white text-xs' },
          ['reg', 'doc', 'pharm', 'tv'].map(v => 
            React.createElement('button', { key: v, onClick: () => setView(v), className: `uppercase ${view === v ? 'text-blue-400 font-bold' : ''}` }, v)
          )
        ),

        // Registration View
        view === 'reg' && React.createElement('div', { className: 'p-6 max-w-xl mx-auto w-full' },
          React.createElement('h1', { className: 'text-2xl font-bold mb-4' }, 'Registration'),
          React.createElement('div', { className: 'flex gap-2 mb-6' },
            React.createElement('input', { 
              type: 'number', value: manualNum, onChange: e => setManualNum(e.target.value), 
              placeholder: 'Enter 1001-1200', className: 'border p-3 rounded w-full' 
            }),
            React.createElement('button', { onClick: register, className: 'bg-blue-600 text-white px-6 rounded' }, 'Register')
          ),
          React.createElement('h2', { className: 'font-bold mb-2' }, 'Current Patients in Clinic'),
          queue.map(p => React.createElement('div', { key: p.id, className: 'bg-white p-3 border-b flex justify-between' }, 
            React.createElement('span', null, `#${p.num}`),
            React.createElement('span', { className: 'text-slate-500 italic uppercase text-xs' }, p.status)
          ))
        ),

        // Doctor View
        view === 'doc' && React.createElement('div', { className: 'p-6 max-w-2xl mx-auto w-full' },
          React.createElement('h1', { className: 'text-2xl font-bold mb-4' }, 'Doctor Dashboard'),
          queue.filter(p => p.status === 'waiting' || p.status === 'consulting' || (p.status === 'calling' && p.loc.includes('Room'))).map(p => 
            React.createElement('div', { key: p.id, className: 'bg-white p-4 mb-2 shadow rounded flex justify-between' },
              React.createElement('span', { className: 'text-xl font-bold' }, `#${p.num}`),
              React.createElement('div', { className: 'flex gap-2' },
                p.status === 'waiting' && React.createElement('button', { onClick: () => callToDoc(p.id, 'Consultation Room 1'), className: 'bg-indigo-600 text-white px-4 py-1 rounded' }, 'Call to R1'),
                p.status === 'consulting' && React.createElement('button', { onClick: () => sendToPharmacy(p.id), className: 'bg-green-600 text-white px-4 py-1 rounded' }, 'Done / Pharmacy')
              )
            )
          )
        ),

        // TV View
        view === 'tv' && React.createElement('div', { className: 'bg-slate-900 text-white flex-1 flex flex-col items-center justify-center p-10 text-center' },
          React.createElement('h1', { className: 'text-blue-400 text-3xl font-bold mb-10 tracking-widest' }, 'NOW CALLING'),
          React.createElement('div', { className: 'text-[15rem] font-black leading-none' }, queue.find(p => p.status === 'calling')?.num || '----'),
          React.createElement('div', { className: 'text-6xl text-green-400 font-bold mt-10' }, queue.find(p => p.status === 'calling')?.loc || 'PLEASE WAIT'),
          !audioEnabled && React.createElement('button', { onClick: () => setAudioEnabled(true), className: 'mt-20 p-4 border border-slate-700 text-slate-500 rounded' }, 'Click Once to Activate Voice')
        )
      );
    }

    const rootElement = document.getElementById('root');
    const root = ReactDOM.createRoot(rootElement);
    root.render(React.createElement(ClinicApp));
  </script>
</body>
</html>
