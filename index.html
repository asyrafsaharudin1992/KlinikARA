<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HSO Clinic System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .view { display: none; }
        .view.active { display: block; }
        .status-pill { padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .bg-waiting { background: #fef3c7; color: #92400e; } /* Yellow */
        .bg-consult { background: #dcfce7; color: #166534; } /* Green */
        .bg-pharmacy { background: #dbeafe; color: #1e40af; } /* Blue */
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <nav class="bg-slate-800 p-3 flex justify-center gap-4 text-white shadow-lg">
        <button onclick="switchView('reg')" class="hover:text-blue-400">Registration</button>
        <button onclick="switchView('doc')" class="hover:text-blue-400">Doctor</button>
        <button onclick="switchView('disp')" class="hover:text-blue-400">Dispensary</button>
        <button onclick="switchView('tv')" class="bg-blue-600 px-3 py-1 rounded">TV Display</button>
    </nav>

    <div id="reg" class="view active p-6 max-w-4xl mx-auto">
        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
            <h2 class="text-xl font-bold mb-4">Manual Registration</h2>
            <div class="flex gap-4 items-end">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Enter Queue Number</label>
                    <input type="number" id="manualNum" min="1001" max="1200" placeholder="1001" class="mt-1 block w-32 border-gray-300 rounded-md shadow-sm border p-2 text-lg">
                </div>
                <button onclick="registerManual()" class="bg-blue-600 text-white px-6 py-2 rounded-md font-bold hover:bg-blue-700">Add to Queue</button>
                <button onclick="resetDay()" class="text-red-500 text-sm ml-auto">Reset Entire Day</button>
            </div>
        </div>
        <div id="regTableContainer"></div>
    </div>

    <div id="doc" class="view p-6 max-w-4xl mx-auto">
        <div class="grid grid-cols-2 gap-4 mb-6 text-center">
            <button onclick="callNext('Consultation Room 1')" class="bg-indigo-600 text-white p-6 rounded-xl font-bold text-xl shadow-lg">Call to Room 1</button>
            <button onclick="callNext('Consultation Room 2')" class="bg-purple-600 text-white p-6 rounded-xl font-bold text-xl shadow-lg">Call to Room 2</button>
        </div>
        <div id="docTableContainer"></div>
    </div>

    <div id="disp" class="view p-6 max-w-4xl mx-auto">
        <h2 class="text-xl font-bold mb-4">Dispensary & Billing</h2>
        <div id="dispTableContainer"></div>
    </div>

    <div id="tv" class="view h-screen bg-slate-900 text-white overflow-hidden">
        <div class="flex h-full">
            <div class="w-2/3 flex flex-col items-center justify-center border-r border-slate-700 text-center">
                <h1 class="text-3xl text-blue-400 font-bold mb-6 tracking-widest uppercase">Now Calling</h1>
                <div id="tvNum" class="text-[18rem] font-black leading-none">----</div>
                <div id="tvLoc" class="text-6xl text-green-400 font-bold mt-6 uppercase">Waiting</div>
                <button onclick="enableAudio()" id="audioBtn" class="mt-10 text-xs text-slate-500 border border-slate-700 p-2 rounded">Click to Enable Sound</button>
            </div>
            <div class="w-1/3 p-10 bg-slate-800">
                <h2 class="text-2xl text-slate-400 border-b border-slate-600 pb-2 mb-6">Queue History</h2>
                <div id="history" class="space-y-6 text-4xl font-bold text-slate-300"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, limit, doc, updateDoc, getDocs, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCDxci4g-9QFvo_6ymov1mxdvn7Jf_mhvg",
  authDomain: "clinicqueue-d9d3a.firebaseapp.com",
  projectId: "clinicqueue-d9d3a",
  storageBucket: "clinicqueue-d9d3a.firebasestorage.app",
  messagingSenderId: "45318170672",
  appId: "1:45318170672:web:3edd81acbb292c2889a5f5",
  measurementId: "G-S5NEHZD6F3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const colRef = collection(db, "clinicQueue");

        window.switchView = (id) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        };

        // --- SHARED UI TABLE LOGIC ---
        onSnapshot(query(colRef, orderBy("num", "asc")), (snap) => {
            let html = `<table class="w-full bg-white rounded-lg shadow overflow-hidden">
                <thead class="bg-gray-50 border-b">
                    <tr><th class="p-3 text-left">Queue No</th><th class="p-3 text-left">Status</th><th class="p-3 text-right">Actions</th></tr>
                </thead><tbody>`;
            
            snap.forEach(d => {
                const p = d.data();
                const id = d.id;
                let statusClass = p.status === 'waiting' ? 'bg-waiting' : (p.status === 'dispensary' ? 'bg-pharmacy' : 'bg-consult');
                
                html += `<tr class="border-b">
                    <td class="p-3 text-xl font-bold">#${p.num}</td>
                    <td class="p-3"><span class="status-pill ${statusClass}">${p.status.toUpperCase()}</span></td>
                    <td class="p-3 text-right">
                        ${p.status === 'consulting' ? `<button onclick="finishCheckup('${id}')" class="text-green-600 text-sm font-bold underline">Send to Pharmacy</button>` : ''}
                        ${p.status === 'dispensary' ? `<button onclick="callDisp('${id}', '${p.num}')" class="text-blue-600 text-sm font-bold underline mr-2">Call</button> <button onclick="complete('${id}')" class="text-red-600 text-sm font-bold underline">Done</button>` : ''}
                        ${p.status === 'waiting' ? `<button onclick="complete('${id}')" class="text-gray-400 text-xs">Remove</button>` : ''}
                    </td>
                </tr>`;
            });
            html += `</tbody></table>`;
            document.getElementById('regTableContainer').innerHTML = html;
            document.getElementById('docTableContainer').innerHTML = html;
            document.getElementById('dispTableContainer').innerHTML = html;
        });

        // --- LOGIC FUNCTIONS ---
        window.registerManual = async () => {
            const num = document.getElementById('manualNum').value;
            if(!num) return alert("Enter a number");
            await addDoc(colRef, { num: parseInt(num), status: 'waiting', loc: '', time: Date.now() });
            document.getElementById('manualNum').value = "";
        };

        window.callNext = async (room) => {
            const q = query(colRef, where("status", "==", "waiting"), orderBy("time", "asc"), limit(1));
            const snap = await getDocs(q);
            if(!snap.empty) {
                await updateDoc(doc(db, "clinicQueue", snap.docs[0].id), { status: 'calling', loc: room, time: Date.now() });
                // Move to "consulting" state after 5 seconds
                setTimeout(() => updateDoc(doc(db, "clinicQueue", snap.docs[0].id), { status: 'consulting' }), 5000);
            }
        };

        window.finishCheckup = async (id) => {
            await updateDoc(doc(db, "clinicQueue", id), { status: 'dispensary', loc: 'Waiting Area' });
        };

        window.callDisp = async (id, num) => {
            await updateDoc(doc(db, "clinicQueue", id), { status: 'calling', loc: 'Dispensary Counter', time: Date.now() });
        };

        window.complete = async (id) => { await deleteDoc(doc(db, "clinicQueue", id)); };

        window.resetDay = async () => {
            if(confirm("Clear all data?")) {
                const snap = await getDocs(colRef);
                const batch = writeBatch(db);
                snap.forEach(d => batch.delete(d.ref));
                await batch.commit();
            }
        };

        // --- TV AUDIO ---
        let audio = false;
        window.enableAudio = () => { audio = true; document.getElementById('audioBtn').innerText = "AUDIO ON"; };
        
        onSnapshot(query(colRef, where("status", "==", "calling"), orderBy("time", "desc"), limit(5)), (snap) => {
            if (snap.empty) return;
            const top = snap.docs[0].data();
            document.getElementById('tvNum').innerText = top.num;
            document.getElementById('tvLoc').innerText = top.loc;
            
            const hist = document.getElementById('history');
            hist.innerHTML = "";
            snap.docs.slice(1).forEach(d => {
                hist.innerHTML += `<div class="flex justify-between border-b border-slate-700 pb-2"><span>${d.data().num}</span><span class="text-lg text-slate-500">${d.data().loc}</span></div>`;
            });

            if(audio) {
                window.speechSynthesis.cancel();
                const msg = new SpeechSynthesisUtterance(`${top.num}, please proceed to ${top.loc}`);
                msg.rate = 0.8;
                window.speechSynthesis.speak(msg);
            }
        });
    </script>
</body>
</html>
