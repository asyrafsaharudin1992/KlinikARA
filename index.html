<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SwiftQueue Clinic Pro - Priority Mode</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.3); }
    .tv-dark { background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%); }
    .priority-pulse { animation: priority-glow 2s infinite; }
    @keyframes priority-glow {
      0%, 100% { box-shadow: 0 0 5px rgba(239, 68, 68, 0.5); border-color: rgba(239, 68, 68, 0.5); }
      50% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.8); border-color: rgba(239, 68, 68, 1); }
    }
    @keyframes text-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; color: #ef4444; }
    }
    .tv-priority-num { animation: text-pulse 1.5s infinite; }
  </style>

  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@18.2.0",
      "react-dom": "https://esm.sh/react-dom@18.2.0/client"
    }
  }
  </script>
</head>
<body class="bg-slate-50 text-slate-900 antialiased">
  <div id="root"></div>

  <script type="module">
    import React, { useState, useEffect, useRef } from 'react';
    import ReactDOM from 'react-dom';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCDxci4g-9QFvo_6ymov1mxdvn7Jf_mhvg",
      authDomain: "clinicqueue-d9d3a.firebaseapp.com",
      projectId: "clinicqueue-d9d3a",
      storageBucket: "clinicqueue-d9d3a.firebasestorage.app",
      messagingSenderId: "45318170672",
      appId: "1:45318170672:web:3edd81acbb292c2889a5f5",
      measurementId: "G-S5NEHZD6F3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const qRef = collection(db, "queue");

    const playChime = (audioCtx) => {
      const now = audioCtx.currentTime;
      const playTone = (freq, start, duration) => {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(freq, start);
        gain.gain.setValueAtTime(0, start);
        gain.gain.linearRampToValueAtTime(0.15, start + 0.1);
        gain.gain.exponentialRampToValueAtTime(0.001, start + duration);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(start); osc.stop(start + duration);
      };
      playTone(554.37, now, 1.2); 
      playTone(440.00, now + 0.25, 1.2); 
    };

    function SwiftQueue() {
      const [view, setView] = useState('reg'); 
      const [queue, setQueue] = useState([]);
      const [inputNum, setInputNum] = useState('');
      const [patientName, setPatientName] = useState('');
      const [isPriority, setIsPriority] = useState(false);
      const [audioEnabled, setAudioEnabled] = useState(false);
      const audioCtx = useRef(null);
      const lastCalledId = useRef(null);

      useEffect(() => {
        // Sort by priority first, then by time
        const q = query(qRef, orderBy("isPriority", "desc"), orderBy("time", "asc"));
        return onSnapshot(q, (snapshot) => {
          setQueue(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });
      }, []);

      useEffect(() => {
        if (view !== 'tv' || !audioEnabled) return;
        const activeCall = queue.find(p => p.status === 'calling');
        if (activeCall && activeCall.id !== lastCalledId.current) {
          lastCalledId.current = activeCall.id;
          if (!audioCtx.current) audioCtx.current = new (window.AudioContext || window.webkitAudioContext)();
          playChime(audioCtx.current);
          setTimeout(() => {
            const utterance = new SpeechSynthesisUtterance();
            const priorityText = activeCall.isPriority ? "Panggilan kecemasan... Emergency call..." : "";
            utterance.text = `${priorityText} Nombor ${activeCall.num}... Number ${activeCall.num}... Sila ke... Please proceed to... ${activeCall.loc}`;
            const voices = window.speechSynthesis.getVoices();
            const malayVoice = voices.find(v => (v.lang.includes('ms') || v.lang.includes('id')) && v.name.toLowerCase().includes('female'));
            if (malayVoice) utterance.voice = malayVoice;
            utterance.rate = 0.8;
            utterance.onend = () => setTimeout(() => playChime(audioCtx.current), 500);
            window.speechSynthesis.speak(utterance);
          }, 1200);
        }
      }, [queue, view, audioEnabled]);

      const register = async (num) => {
        const n = num || inputNum;
        if (!n) return;
        await addDoc(qRef, { 
            num: parseInt(n), 
            name: patientName || 'Pesakit Am', 
            isPriority: isPriority,
            status: 'waiting', 
            loc: '', 
            time: Date.now() 
        });
        setInputNum(''); setPatientName(''); setIsPriority(false);
      };

      const updatePatient = async (id, status, loc) => {
        await updateDoc(doc(db, "queue", id), { status, loc, time: Date.now() });
      };

      const resetAll = async () => {
        if(confirm("Confirm reset?")) {
          const snap = await getDocs(qRef);
          const batch = writeBatch(db);
          snap.forEach(d => batch.delete(d.ref));
          await batch.commit();
        }
      };

      return React.createElement('div', { className: 'min-h-screen flex flex-col' },
        React.createElement('nav', { className: 'glass sticky top-0 z-50 px-6 py-4 flex justify-between items-center shadow-sm' },
          React.createElement('div', { className: 'flex flex-col' },
            React.createElement('span', { className: 'font-black text-xl tracking-tighter leading-none' }, 'HSO HEALTHCARE'),
            React.createElement('span', { className: 'text-[10px] font-bold opacity-50 uppercase tracking-widest' }, 'Klinik & Surgeri')
          ),
          React.createElement('div', { className: 'flex gap-2 bg-slate-100 p-1 rounded-xl' },
            ['reg', 'doc', 'tv'].map(v => 
              React.createElement('button', { 
                key: v, onClick: () => setView(v),
                className: `px-4 py-2 rounded-lg text-xs font-bold transition-all ${view === v ? 'bg-white shadow-sm text-blue-600' : 'text-slate-500'}`
              }, v.toUpperCase())
            )
          )
        ),

        React.createElement('main', { className: 'flex-1' },
          
          view === 'reg' && React.createElement('div', { className: 'p-8 max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8' },
            React.createElement('div', { className: 'lg:col-span-4 space-y-4' },
              React.createElement('div', { className: 'bg-white p-6 rounded-2xl shadow-sm border' },
                React.createElement('h2', { className: 'text-lg font-bold mb-4' }, 'Pendaftaran'),
                React.createElement('input', { 
                  type: 'text', placeholder: 'Nama Pesakit', value: patientName, 
                  onChange: e => setPatientName(e.target.value),
                  className: 'w-full mb-3 border-slate-200 border rounded-xl px-4 py-3 outline-none focus:border-blue-500'
                }),
                React.createElement('input', { 
                  type: 'number', placeholder: 'No. Manual', value: inputNum, 
                  onChange: e => setInputNum(e.target.value),
                  className: 'w-full mb-4 border-slate-200 border rounded-xl px-4 py-3 outline-none focus:border-blue-500'
                }),
                React.createElement('label', { className: 'flex items-center gap-3 p-3 rounded-xl border border-red-100 bg-red-50 mb-4 cursor-pointer' },
                  React.createElement('input', { 
                    type: 'checkbox', checked: isPriority, onChange: e => setIsPriority(e.target.checked),
                    className: 'w-5 h-5 accent-red-600'
                  }),
                  React.createElement('div', null,
                    React.createElement('div', { className: 'text-xs font-bold text-red-700' }, 'KECEMASAN / URGENT'),
                    React.createElement('div', { className: 'text-[10px] text-red-600 opacity-70' }, 'Patient will move to top of list')
                  )
                ),
                React.createElement('button', { onClick: () => register(), className: 'w-full py-4 bg-blue-600 text-white rounded-xl font-bold shadow-lg' }, 'DAFTAR')
              ),
              React.createElement('button', { onClick: resetAll, className: 'w-full py-3 text-slate-400 text-xs hover:text-red-500' }, 'RESET SYSTEM')
            ),
            React.createElement('div', { className: 'lg:col-span-8 bg-white rounded-2xl border shadow-sm' },
              React.createElement('div', { className: 'p-4 border-b bg-slate-50 font-bold text-xs text-slate-500' }, 'LIVE MONITOR'),
              queue.map(p => React.createElement('div', { key: p.id, className: `p-4 border-b flex items-center justify-between ${p.isPriority ? 'bg-red-50/50' : ''}` },
                React.createElement('div', { className: 'flex items-center gap-4' },
                  React.createElement('span', { className: `text-xl font-black ${p.isPriority ? 'text-red-600' : ''}` }, `#${p.num}`),
                  React.createElement('div', null,
                    React.createElement('div', { className: 'text-sm font-bold' }, p.name),
                    p.isPriority && React.createElement('span', { className: 'text-[10px] font-bold text-red-600' }, '!!! URGENT')
                  )
                ),
                React.createElement('button', { onClick: () => deleteDoc(doc(db, "queue", p.id)), className: 'text-slate-300 hover:text-red-500 font-bold' }, 'âœ•')
              ))
            )
          ),

          view === 'doc' && React.createElement('div', { className: 'p-8 max-w-4xl mx-auto' },
            React.createElement('div', { className: 'grid grid-cols-2 gap-6 mb-8' },
              ['Consultation Room 1', 'Consultation Room 2'].map(room => 
                React.createElement('div', { key: room, className: 'bg-white p-8 rounded-3xl border shadow-sm text-center' },
                  React.createElement('h3', { className: 'text-blue-600 font-bold mb-4 uppercase' }, room),
                  React.createElement('button', { 
                    onClick: () => {
                      // Logic finds top priority waiting patient first
                      const next = queue.find(p => p.status === 'waiting');
                      if(next) updatePatient(next.id, 'calling', room);
                    },
                    className: 'w-full py-4 bg-slate-900 text-white rounded-2xl font-bold hover:shadow-xl'
                  }, 'CALL NEXT')
                )
              )
            ),
            React.createElement('div', { className: 'bg-white rounded-2xl border shadow-sm' },
              queue.filter(p => p.status !== 'waiting').map(p => React.createElement('div', { key: p.id, className: `p-5 border-b flex items-center justify-between ${p.isPriority ? 'priority-pulse bg-red-50/30' : ''}` },
                React.createElement('div', null,
                  React.createElement('div', { className: `text-2xl font-black ${p.isPriority ? 'text-red-600' : ''}` }, `#${p.num}`),
                  React.createElement('div', { className: 'text-[10px] text-slate-400 font-bold' }, p.name)
                ),
                React.createElement('div', { className: 'flex gap-2' },
                  p.status === 'calling' && React.createElement('button', { onClick: () => updatePatient(p.id, 'consulting', p.loc), className: 'bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold' }, 'IN ROOM'),
                  p.status === 'consulting' && React.createElement('button', { onClick: () => updatePatient(p.id, 'pharmacy', 'Dispensary'), className: 'bg-emerald-600 text-white px-4 py-2 rounded-lg text-xs font-bold' }, 'SEND TO PHARMACY'),
                  p.status === 'pharmacy' && React.createElement('button', { onClick: () => deleteDoc(doc(db, "queue", p.id)), className: 'bg-slate-200 px-4 py-2 rounded-lg text-xs font-bold' }, 'FINISH')
                )
              ))
            )
          ),

          view === 'tv' && React.createElement('div', { className: 'tv-dark h-[calc(100vh-72px)] text-white flex' },
            React.createElement('div', { className: 'flex-1 flex flex-col items-center justify-center p-20 border-r border-white/5' },
              React.createElement('div', { className: `text-2xl font-black uppercase mb-10 ${queue.find(p => p.status === 'calling')?.isPriority ? 'text-red-500 animate-pulse' : 'text-blue-400'}` }, 
                queue.find(p => p.status === 'calling')?.isPriority ? 'Kecemasan / Emergency' : 'Now Calling'
              ),
              React.createElement('div', { className: `text-[22rem] font-black leading-none mb-10 ${queue.find(p => p.status === 'calling')?.isPriority ? 'tv-priority-num' : ''}` }, 
                queue.find(p => p.status === 'calling')?.num || '----'
              ),
              React.createElement('div', { className: 'text-6xl font-medium text-emerald-400 uppercase text-center' }, 
                queue.find(p => p.status === 'calling')?.loc || 'SILA TUNGGU'
              ),
              !audioEnabled && React.createElement('button', { 
                onClick: () => { setAudioEnabled(true); alert("Audio Active"); },
                className: 'mt-20 px-8 py-3 bg-white/10 rounded-full border border-white/10 text-xs font-bold'
              }, 'ENABLE SOUND')
            ),
            React.createElement('div', { className: 'w-1/3 bg-black/20 p-12' },
                React.createElement('h2', { className: 'text-slate-500 font-bold mb-10 uppercase text-xs' }, 'History'),
                React.createElement('div', { className: 'space-y-12' }, 
                  queue.filter(p => p.status !== 'waiting' && p.status !== 'calling').slice(0, 5).map(h => 
                    React.createElement('div', { key: h.id, className: 'flex justify-between border-b border-white/5 pb-4' },
                      React.createElement('span', { className: `text-7xl font-bold ${h.isPriority ? 'text-red-400' : ''}` }, h.num),
                      React.createElement('span', { className: 'text-slate-400 font-bold uppercase text-[10px]' }, h.loc)
                    )
                  )
                )
            )
          )
        )
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(SwiftQueue));
  </script>
</body>
</html>
