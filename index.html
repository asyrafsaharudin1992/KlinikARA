<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwiftQueue Pro - Auto Recovery</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color:white; margin: 0; overflow: hidden; height: 100vh; width: 100vw; }
        #loading-msg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; display: flex; align-items: center; justify-content: center; z-index: 9999; flex-direction: column; gap: 10px; }
        #error-box { display: none; background: #ef4444; color: white; padding: 20px; border-radius: 10px; max-width: 80%; text-align: center; font-weight: bold; z-index: 10000; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        
        /* APP STYLES */
        .tv-dark { background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%); height: 100%; width: 100%; display: flex; flex-direction: column; }
        .glass-panel { background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.15); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        .tv-grid-inner { display: grid; grid-template-columns: 1.6fr 1fr; flex: 1; gap: 20px; padding: 30px; box-sizing: border-box; overflow: hidden; min-height: 0; height: calc(100% - 60px); }
        .ticker-bar { position: absolute; bottom: 0; width: 100%; height: 60px; background: black; color: #fbbf24; display: flex; align-items: center; font-size: 1.5rem; font-weight: 800; border-top: 4px solid #d97706; z-index: 50; flex-shrink: 0; }
        .ticker-move { white-space: nowrap; animation: marquee 30s linear infinite; display: inline-block; padding-left: 100%; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        @keyframes flash-call { 0%, 100% { opacity: 1; color: white; transform: scale(1); text-shadow: 0 0 30px rgba(255,255,255,0.8); } 50% { opacity: 1; color: #60a5fa; transform: scale(1.02); } }
        .animate-calling { animation: flash-call 0.8s ease-in-out infinite; }
        .nav-light { background: white; border-bottom: 2px solid #e2e8f0; color: #0f172a; }
        .admin-layout { display: grid; grid-template-columns: 1fr 380px; height: calc(100vh - 90px); gap: 20px; padding: 20px; box-sizing: border-box; background: #f8fafc; }
        .screensaver-layer { transition: opacity 1s ease-in-out; opacity: 0; pointer-events: none; z-index: 9999; }
        .screensaver-active { opacity: 1; pointer-events: auto; }
    </style>

    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
    
    <div id="loading-msg">
        <svg class="animate-spin h-10 w-10 text-blue-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        <span class="text-xl font-bold">Connecting to Clinic System...</span>
        <span class="text-sm text-slate-500">Wait 5 seconds...</span>
    </div>

    <div id="error-box"></div>

    <div id="root"></div>

    <script type="text/babel">
        // --- ERROR HANDLER ---
        window.onerror = function(message, source, lineno, colno, error) {
            document.getElementById('loading-msg').style.display = 'none';
            document.getElementById('error-box').style.display = 'block';
            document.getElementById('error-box').innerHTML = "SYSTEM ERROR:<br>" + message + "<br><br>Check Internet Connection & Refresh.";
        };

        // --- SAFE STORAGE ---
        const safeStorage = {
            getItem: (k) => { try { return localStorage.getItem(k); } catch(e){ return null; } },
            setItem: (k, v) => { try { localStorage.setItem(k, v); } catch(e){} }
        };

        // --- FIREBASE INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyCDxci4g-9QFvo_6ymov1mxdvn7Jf_mhvg",
            authDomain: "clinicqueue-d9d3a.firebaseapp.com",
            projectId: "clinicqueue-d9d3a",
            storageBucket: "clinicqueue-d9d3a.firebasestorage.app",
            messagingSenderId: "45318170672",
            appId: "1:45318170672:web:3edd81acbb292c2889a5f5",
            measurementId: "G-S5NEHZD6F3"
        };

        // Safety Check
        if (typeof firebase === 'undefined') {
            throw new Error("Firebase library failed to load. Check your internet connection.");
        }

        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.firestore();

        // --- CONSTANTS & HELPERS ---
        const CUSTOM_CHIME_URL = 'https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3';
        const DEFAULT_ROOMS = ['Room 1', 'Room 2', 'Room 3', 'Nebuliser'];
        const DEFAULT_HEADER = "KLINIK ARA 24 JAM";
        const DEFAULT_FOOTER = "Moga segala urusan\ndimudahkan. Amin.";

        const saveRemarks = (branch, id, newRemarks) => {
            db.collection("branches").doc(branch).collection("queue").doc(id).update({ remarks: newRemarks });
        };

        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800; 
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6)); 
                    };
                };
            });
        };

        // --- SUB-COMPONENTS ---
        
        const ClockDisplay = () => {
            const [now, setNow] = React.useState(new Date());
            React.useEffect(() => { const t = setInterval(() => setNow(new Date()), 1000); return () => clearInterval(t); }, []);
            return (
                <div className="text-center">
                    <div className="text-7xl font-black text-blue-300 drop-shadow-md">{now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12: true})}</div>
                    <div className="text-2xl font-bold text-white/80 uppercase mt-2 tracking-widest">{now.toLocaleDateString('en-GB', {weekday:'long', day:'2-digit', month:'long'})}</div>
                </div>
            );
        };

        const StatusBadge = ({ status }) => {
            let color = "bg-slate-100 text-slate-500";
            if(status === 'calling') color = "bg-red-100 text-red-600 animate-pulse";
            if(status === 'consulting') color = "bg-green-100 text-green-700";
            if(status === 'pending') color = "bg-orange-100 text-orange-600";
            if(status === 'collecting') color = "bg-blue-100 text-blue-600";
            if(status === 'finished') color = "bg-gray-200 text-gray-500";
            return <span className={`text-[9px] font-black px-2 py-1 rounded uppercase text-center min-w-[70px] ${color}`}>{status}</span>;
        };

        const MonitorList = ({ isDark, queue }) => {
            return (
                <div className="flex flex-col w-full">
                    {queue.map(p => (
                        <div key={p.id} className={`grid grid-cols-[0.6fr_1.5fr_1fr_1fr] items-center p-4 border-b ${isDark ? 'border-white/10' : 'border-slate-100'}`}>
                            <span className={`${isDark ? 'text-4xl text-white' : 'text-xl'} font-black drop-shadow-sm`}>#{p.num}</span>
                            <span className={`${isDark ? 'text-xl text-white' : 'text-[11px]'} font-bold uppercase truncate pr-2 tracking-wide`}>{p.name || '-'}</span>
                            <div className="flex justify-center"><StatusBadge status={p.status} /></div>
                            <span className={`text-right font-bold uppercase text-[12px] ${isDark?'text-emerald-300':'text-slate-500'}`}>{p.loc}</span>
                        </div>
                    ))}
                </div>
            );
        };

        const LiveMonitor = ({ isDark, queue }) => (
            <div className={`rounded-2xl border overflow-hidden flex flex-col h-full ${isDark ? 'glass-panel text-white' : 'bg-white'}`} style={{ maxHeight: '100%', minHeight: 0 }}>
                <div className={`p-4 font-bold border-b text-[10px] uppercase tracking-widest flex justify-between ${isDark ? 'text-white/40 border-white/10' : 'text-slate-400'}`}><span>{isDark ? 'Queue Monitor' : 'Branch Monitor'}</span></div>
                <div className={`grid grid-cols-[0.6fr_1.5fr_1fr_1fr] px-4 py-3 text-[10px] font-bold uppercase tracking-wider ${isDark ? 'text-white/50' : 'text-slate-400 bg-slate-50 border-b border-slate-100'}`}>
                    <div>No.</div><div>Name</div><div className="text-center">Status</div><div className="text-right">Location</div>
                </div>
                <div className="flex-1 custom-scrollbar min-h-0 overflow-y-auto">
                    <MonitorList isDark={isDark} queue={queue} />
                </div>
            </div>
        );

        const SettingsModal = ({ setShowSettings, branch, rooms, setRooms, ticketHeader, setTicketHeader, ticketFooter, setTicketFooter, voiceSpeed, setVoiceSpeed, uiScale, setUiScale }) => {
            const [localRooms, setLocalRooms] = React.useState(rooms);
            const [newRoom, setNewRoom] = React.useState('');
            const [posterStatus, setPosterStatus] = React.useState('Upload');
            
            const handleSave = () => {
                setRooms(localRooms);
                db.collection("branches").doc(branch).collection("settings").doc("config").set({
                    rooms: localRooms, header: ticketHeader, footer: ticketFooter
                });
                setShowSettings(false);
            };

            const handleUpload = async (e) => {
                const file = e.target.files[0];
                if(file) {
                    setPosterStatus('Processing...');
                    const base64 = await compressImage(file);
                    await db.collection("branches").doc(branch).collection("settings").doc("promo").set({ image: base64 });
                    setPosterStatus('Done');
                }
            };

            return (
                <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center backdrop-blur-sm text-slate-800">
                    <div className="bg-white p-8 rounded-2xl w-[500px] max-h-[80vh] overflow-y-auto">
                        <h2 className="text-xl font-black mb-4">Settings</h2>
                        <div className="space-y-4">
                            <div><label className="text-xs font-bold uppercase">Poster</label><input type="file" onChange={handleUpload} className="block w-full text-sm mt-1"/></div>
                            <div><label className="text-xs font-bold uppercase">Ticket Header</label><input value={ticketHeader} onChange={e=>setTicketHeader(e.target.value)} className="w-full border p-2 rounded"/></div>
                            <div><label className="text-xs font-bold uppercase">Ticket Footer</label><textarea value={ticketFooter} onChange={e=>setTicketFooter(e.target.value)} className="w-full border p-2 rounded"></textarea></div>
                            <div><label className="text-xs font-bold uppercase">Voice Speed ({voiceSpeed})</label><input type="range" min="0.5" max="1.5" step="0.1" value={voiceSpeed} onChange={e=>setVoiceSpeed(parseFloat(e.target.value))} className="w-full"/></div>
                            <div><label className="text-xs font-bold uppercase">TV Scale ({uiScale})</label><input type="range" min="0.5" max="2.0" step="0.1" value={uiScale} onChange={e=>setUiScale(parseFloat(e.target.value))} className="w-full"/></div>
                        </div>
                        <button onClick={handleSave} className="w-full bg-slate-900 text-white font-bold py-3 rounded-xl mt-6">SAVE & CLOSE</button>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const [view, setView] = React.useState('reg');
            const [branch, setBranch] = React.useState(safeStorage.getItem('clinic_branch') || 'Kajang');
            const [queue, setQueue] = React.useState([]);
            
            // Config
            const [rooms, setRooms] = React.useState(DEFAULT_ROOMS);
            const [ticketHeader, setTicketHeader] = React.useState(DEFAULT_HEADER);
            const [ticketFooter, setTicketFooter] = React.useState(DEFAULT_FOOTER);
            const [promoImage, setPromoImage] = React.useState(null);
            
            // UI State
            const [inputNum, setInputNum] = React.useState('');
            const [inputName, setInputName] = React.useState('');
            const [lastTicket, setLastTicket] = React.useState(null); 
            const [showSettings, setShowSettings] = React.useState(false);
            const [voiceSpeed, setVoiceSpeed] = React.useState(0.85);
            const [uiScale, setUiScale] = React.useState(1.0);
            const [audioOn, setAudioOn] = React.useState(false);
            const [isCalling, setIsCalling] = React.useState(false);
            const [showScreensaver, setShowScreensaver] = React.useState(false);

            // Refs
            const lastCallId = React.useRef(null);
            const lastInteraction = React.useRef(Date.now());
            const chimeRef = React.useRef(new Audio(CUSTOM_CHIME_URL));

            // Load Data
            React.useEffect(() => {
                document.getElementById('loading-msg').style.display = 'none'; // Hide loader when React mounts
                
                safeStorage.setItem('clinic_branch', branch);
                const unsubQueue = db.collection("branches").doc(branch).collection("queue").orderBy("time", "desc").limit(150).onSnapshot(snap => {
                    setQueue(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                    lastInteraction.current = Date.now(); setShowScreensaver(false);
                });
                const unsubPromo = db.collection("branches").doc(branch).collection("settings").doc("promo").onSnapshot(doc => {
                    if(doc.exists && doc.data().image) setPromoImage(doc.data().image); else setPromoImage(null);
                });
                return () => { unsubQueue(); unsubPromo(); };
            }, [branch]);

            // Screensaver Timer
            React.useEffect(() => {
                if (view !== 'tv' || !promoImage) return; 
                const timer = setInterval(() => { if (Date.now() - lastInteraction.current > 20000) setShowScreensaver(true); }, 1000);
                const reset = () => { lastInteraction.current = Date.now(); setShowScreensaver(false); };
                window.onclick = reset; window.onmousemove = reset; window.onkeydown = reset;
                return () => clearInterval(timer);
            }, [view, promoImage]);

            // Audio Logic
            const handleTap = () => { setAudioOn(true); chimeRef.current.play().catch(()=>{}); window.speechSynthesis.speak(new SpeechSynthesisUtterance("")); };
            
            const runSequence = (num, loc) => {
                setIsCalling(true); setTimeout(() => setIsCalling(false), 10000);
                chimeRef.current.pause(); chimeRef.current.currentTime = 0;
                chimeRef.current.play().then(() => {
                    setTimeout(() => {
                        const msg = new SpeechSynthesisUtterance(`Number ${num}, please go to ${loc}`);
                        msg.rate = voiceSpeed;
                        window.speechSynthesis.speak(msg);
                    }, 500);
                });
            };

            // Call Watcher
            React.useEffect(() => {
                const caller = queue.filter(p => p.callTrigger).sort((a,b) => b.callTrigger - a.callTrigger)[0];
                if (view === 'tv' && audioOn && caller && caller.callTrigger !== lastCallId.current) {
                    if ((Date.now() - caller.callTrigger) < 15000) {
                        lastCallId.current = caller.callTrigger;
                        runSequence(caller.num, caller.loc);
                    }
                }
            }, [queue, view, audioOn]);

            // Actions
            const regPatient = () => { if(!inputNum) return; setLastTicket({num:inputNum}); db.collection("branches").doc(branch).collection("queue").add({ num: inputNum, name: inputName, status: 'waiting', loc: 'Waiting', time: Date.now(), callTrigger: 0 }); setInputNum(''); setInputName(''); };
            const updatePatient = (id, s, l, trig) => { 
                const pl = { status: s, loc: l, time: Date.now() }; 
                if(trig) pl.callTrigger = Date.now();
                db.collection("branches").doc(branch).collection("queue").doc(id).update(pl); 
            };
            const resetData = () => { if(confirm("Reset?")) db.collection("branches").doc(branch).collection("queue").get().then(s => s.forEach(d => d.ref.delete())); };

            const sortedQueue = [...queue].sort((a,b) => b.time - a.time);
            const pharmacyQueue = sortedQueue.filter(p => p.status === 'collecting');

            return (
                <div className={`app-interface ${view==='tv'?'tv-dark':'bg-slate-50 text-slate-900'} h-full`}>
                    {showSettings && <SettingsModal {...{setShowSettings, branch, rooms, setRooms, ticketHeader, setTicketHeader, ticketFooter, setTicketFooter, voiceSpeed, setVoiceSpeed, uiScale, setUiScale}} />}
                    
                    {/* SCREENSAVER */}
                    <div className={`fixed inset-0 z-[100] bg-black flex items-center justify-center screensaver-layer ${showScreensaver ? 'screensaver-active' : ''}`}>
                        {promoImage && <img src={promoImage} className="w-full h-full object-cover" />}
                    </div>

                    {/* NAV */}
                    <div className={`global-nav ${view==='tv'?'nav-dark':'nav-light'}`}>
                        <div className="flex gap-4 items-center">
                            <span className="text-xl font-black">SWIFTQUEUE</span>
                            <select value={branch} onChange={e=>setBranch(e.target.value)} className="text-black rounded p-1 text-sm font-bold uppercase">{['Kajang', 'Seri Kembangan', 'Semenyih'].map(b=><option key={b} value={b}>{b}</option>)}</select>
                        </div>
                        <div className="flex gap-2">
                            {['reg','doc','pharmacy','tv'].map(v => <button key={v} onClick={()=>setView(v)} className="px-3 py-1 bg-white/10 rounded text-xs font-bold uppercase hover:bg-white/20">{v}</button>)}
                            <button onClick={()=>setShowSettings(true)}>⚙</button>
                        </div>
                    </div>

                    {/* TV VIEW */}
                    {view === 'tv' && (
                        <div className="tv-wrapper-scaled" style={{transform: `scale(${uiScale})`}}>
                            <div className="tv-grid-inner">
                                <div className="flex flex-col items-center justify-start relative glass-panel rounded-[40px] p-8 pt-16 gap-2">
                                    {!audioOn && <div onClick={handleTap} className="absolute inset-0 bg-black/80 z-50 flex items-center justify-center rounded-[40px] cursor-pointer"><button className="px-8 py-4 bg-blue-600 rounded-full font-bold animate-pulse">TAP TO START AUDIO</button></div>}
                                    <span className="text-blue-300 text-3xl font-black uppercase tracking-[0.3em]">Now Calling</span>
                                    <div className={`font-black text-white leading-[0.85] drop-shadow-lg ${isCalling?'animate-calling':''}`} style={{fontSize: '26vh'}}>{queue.filter(p => p.callTrigger).sort((a,b)=>b.callTrigger-a.callTrigger)[0]?.num || '---'}</div>
                                    <div className="text-5xl font-bold uppercase mt-4">{queue.filter(p => p.callTrigger).sort((a,b)=>b.callTrigger-a.callTrigger)[0]?.name || '...'}</div>
                                    <div className="text-6xl font-black text-emerald-400 uppercase mt-2">{queue.filter(p => p.callTrigger).sort((a,b)=>b.callTrigger-a.callTrigger)[0]?.loc || 'Standby'}</div>
                                </div>
                                <div className="flex flex-col gap-6">
                                    <div className="glass-panel p-6 rounded-[40px] shadow-2xl"><ClockDisplay /></div>
                                    <LiveMonitor isDark={true} queue={sortedQueue} />
                                </div>
                            </div>
                            <div className="ticker-bar"><div className="ticker-move">Selamat datang ke KLINIK ARA 24 JAM. Mohon bersabar sehingga nombor dipanggil.</div></div>
                        </div>
                    )}

                    {/* ADMIN VIEWS */}
                    {view !== 'tv' && (
                        <div className="admin-layout">
                            <div className="bg-white rounded-[30px] border shadow-sm flex flex-col overflow-hidden relative">
                                {view === 'reg' && (
                                    <div className="p-10 flex flex-col gap-4 max-w-sm mx-auto mt-10">
                                        <h1 className="text-3xl font-black text-center">Registration</h1>
                                        <input placeholder="Name" value={inputName} onChange={e=>setInputName(e.target.value)} className="border p-3 rounded font-bold" />
                                        <input placeholder="000" type="number" value={inputNum} onChange={e=>setInputNum(e.target.value)} className="border p-3 rounded text-4xl font-black text-center" />
                                        <button onClick={regPatient} className="bg-slate-900 text-white py-4 rounded font-bold">REGISTER</button>
                                        <button onClick={resetData} className="text-red-400 text-xs font-bold mt-4">RESET DATABASE</button>
                                    </div>
                                )}
                                {(view === 'doc' || view === 'pharmacy') && (
                                    <div className="flex flex-col h-full">
                                        <div className="p-4 bg-slate-100 font-bold border-b flex justify-between"><span>{view.toUpperCase()} QUEUE</span><span>{queue.length} Active</span></div>
                                        <div className="flex-1 overflow-y-auto p-4 space-y-2">
                                            {(view==='pharmacy'?pharmacyQueue:sortedQueue).map(p => (
                                                <div key={p.id} className="bg-white p-4 border rounded flex justify-between items-center shadow-sm">
                                                    <div><div className="text-2xl font-black">#{p.num}</div><div className="text-xs font-bold text-blue-600">{p.name}</div><div className="text-[10px] font-bold text-slate-400">{p.loc}</div></div>
                                                    <div className="flex gap-2">
                                                        {view === 'doc' && rooms.map(r => <button key={r} onClick={()=>updatePatient(p.id, 'calling', r, true)} className="bg-slate-800 text-white px-2 py-1 rounded text-[10px] font-bold">CALL {r}</button>)}
                                                        {view === 'doc' && <button onClick={()=>updatePatient(p.id, 'collecting', 'Pharmacy', false)} className="bg-blue-600 text-white px-2 py-1 rounded text-[10px] font-bold">PHARMACY</button>}
                                                        {view === 'pharmacy' && <button onClick={()=>updatePatient(p.id, 'finished', 'Done', false)} className="bg-green-600 text-white px-4 py-2 rounded font-bold">DONE</button>}
                                                        <button onClick={()=>db.collection("branches").doc(branch).collection("queue").doc(p.id).delete()} className="text-slate-300">✕</button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                            <div className="h-full overflow-hidden bg-white rounded-[30px] border shadow-sm">
                                <LiveMonitor isDark={false} queue={sortedQueue} />
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
